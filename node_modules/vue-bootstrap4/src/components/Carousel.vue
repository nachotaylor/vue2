<template>
    <div class="carousel">
        <div class="carousel-inner">
            <transition 
                v-for="(item, index) in items"
                mode="in-out"
                :css="false"
                @before-enter="beforeEnter"
                @enter="enter"
                @after-enter="afterEnter"
                @before-leave="beforeLeave"
                @leave="leave"
                @after-leave="afterLeave" >
                <div v-show="index === active" class="carousel-item">
                    <img class="d-flex" :src="item.src" alt="item.alt" />
                </div>
            </transition>
        </div>
        <template v-if="control">
            <a @click="onPrev" class="carousel-control-prev" href="javascript: void(0)" role="button">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a @click="onNext" class="carousel-control-next" href="javascript: void(0)" role="button">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </template>
        <ol v-if="indicator" class="carousel-indicators">
            <li v-for="(item, index) in items" @click="target(index)" :class="[(index === active) ? 'active' : '']"></li>
        </ol>
    </div>
</template>

<script>
    import Debug from 'debug';
    Debug.enable('*');
    const debug = Debug('Carousel');
    export default {
        props: {
            items: {
                type: Array,
                required: true
            },
            internal: {
                type: Number,
                default: 5000
            },
            control: {
                type: Boolean,
                default: false
            },
            indicator: {
                type: Boolean,
                default: false
            }
        },
        data () {
            return {
                active: 0,
                animation: '',
                entering: false,
                leaving: false
            }
        },
        computed: {
            transforming() {
                return this.entering || this.leaving;
            }
        },
        methods: {
            onPrev () {
                this.switch(this.active - 1, 'right');
            },
            onNext () {
                this.switch(this.active + 1, 'left');
            },
            target (index) {
                if (index < this.active) {
                    this.switch(index, 'right');
                } else if (index > this.active) {
                    this.switch(index, 'left');
                }
            },
            switch(index, animation) {
                if(this.transforming) {   
                    return;
                }
                this.animation = animation;
                if(index >= this.items.length) {
                    index = 0;
                } else if(index < 0) {
                    index = this.items.length - 1;
                }
                this.active = index;
            },
            beforeEnter(el) {
                this.entering = true;
                const CLASS = {
                    left: 'carousel-item-next',
                    right: 'carousel-item-prev'
                };
                el.classList.add(CLASS[this.animation]);
                debug(`before enter: ${el.classList}`);
            },
            enter(el, done) {
                const CLASS = {
                    left: 'carousel-item-left',
                    right: 'carousel-item-right'
                };
                el.classList.add(CLASS[this.animation]);
                debug(`enter: ${el.classList}`);
                setTimeout(done, 600); // dirty fix, afterEnter is supposed to be called 0.6s later, but is called immediately by Vue and I don't know why.
            },
            afterEnter(el) {
                const CLASS = {
                    left: ['carousel-item-next', 'carousel-item-left'],
                    right: ['carousel-item-prev', 'carousel-item-right']
                };
                el.classList.remove.apply(el.classList, CLASS[this.animation]);
                this.entering = false;
                debug(`after enter: ${el.classList}`);
            },
            beforeLeave(el) {
                this.leaving = true;
                el.classList.add('active');
            },
            leave(el, done) {
                const CLASS = {
                    left: 'carousel-item-left',
                    right: 'carousel-item-right'
                };
                el.classList.add(CLASS[this.animation]);
                setTimeout(done, 600); // dirty fix, afterLeave is supposed to be called 0.6s later, but is called immediately by Vue and I don't know why.
            },
            afterLeave(el) {
                const CLASS = {
                    left: ['active', 'carousel-item-left'],
                    right: ['active', 'carousel-item-right']
                };
                el.classList.remove.apply(el.classList, CLASS[this.animation]);
                this.leaving = false;
            }
        }
    }
</script>

<style>
.carousel-item {
    display: flex;
}
</style>